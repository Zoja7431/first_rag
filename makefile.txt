.PHONY: help build up down logs restart clean test health

# ====================================
# RAG Psychology System - Makefile
# ====================================

help:
	@echo "üê≥ RAG Psychology System - Docker Commands"
	@echo ""
	@echo "Usage: make [command]"
	@echo ""
	@echo "Commands:"
	@echo "  make build          - –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑—ã"
	@echo "  make up             - –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
	@echo "  make down           - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
	@echo "  make restart        - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
	@echo "  make logs           - –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏"
	@echo "  make logs-api       - –õ–æ–≥–∏ —Ç–æ–ª—å–∫–æ FastAPI"
	@echo "  make logs-qdrant    - –õ–æ–≥–∏ —Ç–æ–ª—å–∫–æ Qdrant"
	@echo "  make shell          - –í–æ–π—Ç–∏ –≤ bash –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
	@echo "  make health         - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–∞"
	@echo "  make stats          - –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
	@echo "  make index          - –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å PDF –¥–æ–∫—É–º–µ–Ω—Ç—ã"
	@echo "  make test           - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API"
	@echo "  make clean          - –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
	@echo "  make clean-all      - –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–æ–±—Ä–∞–∑—ã, volumes)"
	@echo ""

# ====================================
# –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´
# ====================================

build:
	@echo "üî® –°–æ–±–∏—Ä–∞—é Docker –æ–±—Ä–∞–∑—ã..."
	docker-compose build

up:
	@echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
	docker-compose up -d
	@sleep 3
	@echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã!"
	@echo "üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:8000/docs"

down:
	@echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
	docker-compose down

restart:
	@echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
	docker-compose restart
	@sleep 2
	@echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã!"

# ====================================
# –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
# ====================================

logs:
	@echo "üìã –õ–æ–≥–∏ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
	docker-compose logs -f

logs-api:
	@echo "üìã –õ–æ–≥–∏ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
	docker-compose logs -f rag-psychology-api

logs-qdrant:
	@echo "üìã –õ–æ–≥–∏ Qdrant..."
	docker-compose logs -f qdrant

logs-tail:
	@echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤..."
	docker-compose logs --tail=50 rag-psychology-api

# ====================================
# –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–ê–Ø –†–ê–ë–û–¢–ê
# ====================================

shell:
	@echo "üîå –í—Ö–æ–¥—É –≤ bash –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
	docker exec -it rag-psychology-api /bin/bash

shell-qdrant:
	@echo "üîå –í—Ö–æ–¥—É –≤ bash Qdrant –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
	docker exec -it qdrant /bin/bash

python-shell:
	@echo "üêç –ó–∞–ø—É—Å–∫–∞—é Python shell –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ..."
	docker exec -it rag-psychology-api python

# ====================================
# –ü–†–û–í–ï–†–ö–ê –ó–î–û–†–û–í–¨–Ø –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê
# ====================================

health:
	@echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞..."
	@curl -s http://localhost:8000/api/health | python -m json.tool || echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω"

stats:
	@echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Qdrant –∫–æ–ª–ª–µ–∫—Ü–∏–∏..."
	@curl -s http://localhost:8000/api/stats | python -m json.tool || echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω"

ps:
	@echo "üì¶ –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
	docker-compose ps

# ====================================
# –†–ê–ë–û–¢–ê –° –î–ê–ù–ù–´–ú–ò
# ====================================

index:
	@echo "üìö –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ PDF –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤..."
	@echo "‚è≥ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 15-30 —Å–µ–∫—É–Ω–¥..."
	@curl -s -X POST http://localhost:8000/api/index | python -m json.tool || echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–∏"

ask-test:
	@echo "‚ùì –¢–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –∫ RAG..."
	@curl -s -X POST http://localhost:8000/api/ask \
		-H "Content-Type: application/json" \
		-d '{"question":"–ß—Ç–æ —Ç–∞–∫–æ–µ —è–∑—ã–∫ —Ç–µ–ª–æ–¥–≤–∏–∂–µ–Ω–∏–π?","k":4}' | python -m json.tool

# ====================================
# –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
# ====================================

test:
	@echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API..."
	@echo ""
	@echo "1Ô∏è‚É£  Health Check:"
	@curl -s http://localhost:8000/api/health | python -m json.tool || echo "‚ùå Health check failed"
	@echo ""
	@echo "2Ô∏è‚É£  Stats:"
	@curl -s http://localhost:8000/api/stats | python -m json.tool || echo "‚ùå Stats failed"

test-ask:
	@echo "üéØ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ endpoint /api/ask..."
	@curl -s -X POST http://localhost:8000/api/ask \
		-H "Content-Type: application/json" \
		-d '{"question":"–ø—Å–∏—Ö–æ–ª–æ–≥–∏—è","k":2}' | python -m json.tool

# ====================================
# –í–ù–£–¢–†–ò –ö–û–ù–¢–ï–ô–ù–ï–†–ê
# ====================================

chunk-analyse:
	@echo "üìä –ó–∞–ø—É—Å–∫–∞—é –∞–Ω–∞–ª–∏–∑ chunks..."
	docker exec rag-psychology-api python -m src.tests.chunk_analyse

env-check:
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
	docker exec rag-psychology-api env | grep -E "QDRANT|GROQ"

pdf-check:
	@echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ PDF —Ñ–∞–π–ª–æ–≤..."
	docker exec rag-psychology-api ls -lah data/psichology_books/

# ====================================
# –û–ß–ò–°–¢–ö–ê
# ====================================

clean:
	@echo "üóëÔ∏è  –£–¥–∞–ª—è—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
	docker-compose down

clean-volumes:
	@echo "üóëÔ∏è  –£–¥–∞–ª—è—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ volumes..."
	docker-compose down -v
	@echo "‚úÖ Volumes —É–¥–∞–ª–µ–Ω—ã!"

clean-all:
	@echo "üóëÔ∏è  –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –æ–±—Ä–∞–∑—ã, volumes)..."
	docker-compose down -v --rmi all
	@echo "‚úÖ –í—Å—ë —É–¥–∞–ª–µ–Ω–æ!"

clean-logs:
	@echo "üóëÔ∏è  –û—á–∏—â–∞—é –ª–æ–≥–∏..."
	docker system prune -f

# ====================================
# –ü–û–õ–ù–´–ô –¶–ò–ö–õ
# ====================================

full-restart: clean build up health
	@echo "‚úÖ –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à—ë–Ω!"

setup: build up health
	@echo "‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

# ====================================
# –ò–ù–§–û–†–ú–ê–¶–ò–Ø
# ====================================

info:
	@echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ:"
	@echo "  API: http://localhost:8000"
	@echo "  Docs: http://localhost:8000/docs"
	@echo "  Qdrant: http://localhost:6333"
	@echo ""
	@echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
	@docker-compose ps --services